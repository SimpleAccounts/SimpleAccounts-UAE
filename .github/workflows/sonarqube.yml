# SonarQube Analysis Pipeline
# Runs code quality and security analysis on every PR and push to main branches

name: SonarQube Analysis

on:
  push:
    branches: ['develop', 'master']
  pull_request:
    branches: ['develop', 'master']
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to analyze (must be develop or master)'
        required: false
        default: 'develop'
        type: choice
        options:
          - develop
          - master

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18.x'
  SONAR_HOST_URL: 'https://sonar-r0w40gg48okc00wkc08oowo4.46.62.252.63.sslip.io'

jobs:
  sonarqube:
    name: Build and Analyze
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for accurate blame information

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'zulu'
          cache: maven

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Cache Node dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install Node dependencies
        run: |
          npm ci --legacy-peer-deps
          cd apps/frontend && npm install --legacy-peer-deps

      # Frontend: Test and Generate Coverage (don't fail on thresholds, just report to SonarQube)
      - name: Test Frontend with Coverage
        working-directory: apps/frontend
        run: npm test -- --coverage --watchAll=false --coverageThreshold='{}' || true
        env:
          CI: true
          NODE_OPTIONS: --openssl-legacy-provider

      # Backend: Build, Test, and Analyze with SonarQube
      - name: Build and Test Backend
        working-directory: apps/backend
        env:
          SPRING_PROFILES_ACTIVE: test
        run: mvn -B test -Dspring.profiles.active=test || true
        continue-on-error: true

      - name: Generate Coverage Report
        working-directory: apps/backend
        run: mvn jacoco:report || true
        continue-on-error: true

      # Import SSL certificate and run SonarQube Analysis
      - name: Import SonarQube SSL Certificate
        run: |
          # Fetch and import the SSL certificate
          echo | openssl s_client -servername sonar-r0w40gg48okc00wkc08oowo4.46.62.252.63.sslip.io \
            -connect sonar-r0w40gg48okc00wkc08oowo4.46.62.252.63.sslip.io:443 2>/dev/null | \
            openssl x509 -out /tmp/sonar.crt
          sudo keytool -import -trustcacerts -keystore $JAVA_HOME/lib/security/cacerts \
            -storepass changeit -noprompt -alias sonarqube -file /tmp/sonar.crt || true

      # Run SonarQube Analysis for Pull Requests
      - name: Run SonarQube Analysis (PR)
        if: github.event_name == 'pull_request'
        working-directory: apps/backend
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
        run: |
          mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=SimpleAccounts_SimpleAccounts-UAE_f0046086-4810-411a-9ca7-6017268b2eb9 \
            -Dsonar.projectName="SimpleAccounts-UAE" \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }} \
            -Dsonar.pullrequest.branch=${{ github.head_ref }} \
            -Dsonar.pullrequest.base=${{ github.base_ref }} \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dsonar.javascript.lcov.reportPaths=../../apps/frontend/coverage/lcov.info \
            -Dsonar.scanner.skipJreProvisioning=true \
            -Dsonar.scanner.os=linux \
            -Dsonar.scanner.arch=x64 \
            -Dsonar.scanner.truststorePath=${JAVA_HOME}/lib/security/cacerts \
            -Dsonar.scanner.truststorePassword=changeit \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.qualitygate.timeout=300 \
            -DskipTests=true

      # Run SonarQube Analysis for Branch pushes
      - name: Run SonarQube Analysis (Branch)
        if: github.event_name != 'pull_request'
        working-directory: apps/backend
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
        run: |
          mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=SimpleAccounts_SimpleAccounts-UAE_f0046086-4810-411a-9ca7-6017268b2eb9 \
            -Dsonar.projectName="SimpleAccounts-UAE" \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.branch.name=${{ github.ref_name }} \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dsonar.javascript.lcov.reportPaths=../../apps/frontend/coverage/lcov.info \
            -Dsonar.scanner.skipJreProvisioning=true \
            -Dsonar.scanner.os=linux \
            -Dsonar.scanner.arch=x64 \
            -Dsonar.scanner.truststorePath=${JAVA_HOME}/lib/security/cacerts \
            -Dsonar.scanner.truststorePassword=changeit \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.qualitygate.timeout=300 \
            -DskipTests=true

      # Check Quality Gate status - fails the workflow if quality gate fails
      - name: Check Quality Gate Status
        if: always()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "Checking Quality Gate status..."
          sleep 15

          PROJECT_KEY="SimpleAccounts_SimpleAccounts-UAE_f0046086-4810-411a-9ca7-6017268b2eb9"

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            API_URL="${{ env.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=${PROJECT_KEY}&pullRequest=${{ github.event.pull_request.number }}"
            DASHBOARD_URL="${{ env.SONAR_HOST_URL }}/dashboard?id=${PROJECT_KEY}&pullRequest=${{ github.event.pull_request.number }}"
          else
            API_URL="${{ env.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=${PROJECT_KEY}&branch=${{ github.ref_name }}"
            DASHBOARD_URL="${{ env.SONAR_HOST_URL }}/dashboard?id=${PROJECT_KEY}&branch=${{ github.ref_name }}"
          fi

          RESPONSE=$(curl -s -u "$SONAR_TOKEN:" "$API_URL")
          STATUS=$(echo "$RESPONSE" | jq -r '.projectStatus.status')

          echo "Quality Gate Status: $STATUS"

          if [ "$STATUS" != "OK" ]; then
            echo "::error::Quality Gate FAILED! New issues were introduced."
            echo "$RESPONSE" | jq -r '.projectStatus.conditions[] | select(.status != "OK") | "  - \(.metricKey): \(.actualValue) (threshold: \(.errorThreshold))"'
            echo "Dashboard: $DASHBOARD_URL"
            exit 1
          fi

          echo "::notice::Quality Gate PASSED!"
          echo "Dashboard: $DASHBOARD_URL"
